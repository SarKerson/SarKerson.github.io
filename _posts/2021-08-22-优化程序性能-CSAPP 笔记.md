---
layout:     post
title:      ä¼˜åŒ–ç¨‹åºæ€§èƒ½
subtitle:   Chapter 5, Optimizing Program Performance - CSAPP Note
date:       2021-10-13
author:     Eric.Y
catalog: true
tags:
    - os
---


# ç¬¬äº”ç«  ä¼˜åŒ–ç¨‹åºæ€§èƒ½

# 0. ä¼˜åŒ–ä¹‹è·¯å’‹èµ°ï¼Ÿ

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YTJmNDAwOWVlZDBhOTRiMGFlNmRkNzllZDAxNmVjZWRfRVVwWERSSThHVk9SVWEwRWpZYTg4azNrczJVRzhzYUpfVG9rZW46Ym94Y25icEk3bjZBSGdRcE5ob056bkpVS0tmXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

1. # é‡åŒ–ç¨‹åºæ€§èƒ½

ä½¿ç”¨ CPEï¼ˆCycles Per Elementï¼‰æ¥é‡åŒ–ç¨‹åºæ€§èƒ½ã€‚å…¶è¡¨ç¤ºæ¯ä¸ªå¾ªç¯æ‰§è¡Œäº†å¤šå°‘ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆå¯ä»¥é¢„ä¼°æ‰§è¡Œäº†å¤šå°‘ä¸ªæŒ‡ä»¤ï¼‰ã€‚

å¯¹äºä¸€ä¸ªâ€œ4GHzâ€çš„å¤„ç†å™¨è€Œè¨€ï¼Œæ—¶é’Ÿè¿è¡Œçš„é¢‘ç‡æ˜¯æ¯ç§’ `4x10^9` ä¸ªå‘¨æœŸï¼Œå³`ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ = 0.25ns`ã€‚

ä¾‹å¦‚ï¼Œ**å°†ç¨‹åºçš„å¾ªç¯çš„** **CPE** **ä» 9 ä¼˜åŒ–åˆ° 6ï¼Œè¡¨ç¤ºæˆ‘ä»¬å°†ç¨‹åºä¸­çš„æ¯ä¸ªå¾ªç¯ï¼Œä»æ¶ˆè€— 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä¼˜åŒ–åˆ° 6 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒèŠ‚çœäº† 3 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=N2QxN2FjMjA5MzNhZTUyODU3ZWVlMTJlNjY4YTFiNDhfRmpYbTduZTcweTRydzR4eXVuUHkzYjBzS0JJcTNUY0JfVG9rZW46Ym94Y25HM0N4d0hjaEZDS3R4YU1zQnE2NUtnXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MjMwZDEwMTY3M2E1YWVhNWJiZDVmN2Y1MmFkY2FhMTFfOURER0xJd0l1TVRXOGxram9ManNLanAwVHhkeURxakFfVG9rZW46Ym94Y24wY1FDWEYySlZnd2JwTzRMWmFNOEtiXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

CPE å…¶å®å°±æ˜¯å³å›¾ä¸­çš„æ–œç‡ï¼Œ**æˆ‘ä»¬çš„ä¼˜åŒ–ç›®æ ‡æ˜¯å°½å¯èƒ½è®©ç›´çº¿èººå¹³ã€‚**

## ä¸ºä»€ä¹ˆè¦ç”¨ CPEï¼Ÿ

å…¶å®å°±æ˜¯æ¯”è¾ƒç›´è§‚ï¼Œè€Œä¸”å®¹æ˜“è·Ÿè¿ç®—å•å…ƒçš„é€Ÿåº¦è¿›è¡Œå…³è”ï¼Œ**å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¼°è®¡å‡ºä¼˜åŒ–çš„å¹…åº¦**ã€‚

**ä¸‹é¢æ˜¯å¸¸è§æ“ä½œçš„** **CPE****ï¼š**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YjM4M2FhZjBkNzA5MjU4NTU4NTBhMDA4YmIzMTkwMTFfR0ViZm0zSnhwdnVEMTZuMEN5dGVxSmo1UEtNWGpSN0RfVG9rZW46Ym94Y25VaVh1alZXWVI3YzdRdEdkRGdBTTJkXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGE1YWRkYTdmYTUyN2JmNmRjZGRjNzkzZDI5OTg5OThfWUVXVjRrMmdya0ppdHh3aFFoRU92aHZvY1VHQVFKVTJfVG9rZW46Ym94Y25yYmZGU0lrZXpIelBLQmxsa3hWSVBlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

**é€šè¿‡****å„ä¸ªæ¨¡å—çš„** **CPE****ï¼Œ****å¿«é€Ÿä¼°ç®—å‡ºä¼˜åŒ–çš„å¹…åº¦ï¼š**

> å¯¹äºæŸå°æœºå™¨ load=2, mul=3, add=1

1. å·¦å›¾ï¼šå…³é”®è·¯å¾„æ¶ˆè€— (load+mul)*n=(2+3)*n=**5n ä¸ªæ—¶é’Ÿå‘¨æœŸ**
2. å³å›¾ï¼šå…³é”®è·¯å¾„æ¶ˆè€— (load+mul+mul)*n/2=(2+3+3)*n/2=**4n ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œé€Ÿåº¦æé«˜ 20%**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTE1OWQ4NmUzNzgxNzhmNzM4NjI3NDFmYjgwMjViOTVfSnptcjBXaTMycDdmR3FiWE84WXA2UU5DWkNiVVk0UHlfVG9rZW46Ym94Y25wajg5UThGU01uNXNyMDhGQmNhcE50XzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NTE5NTdmMmMwNThhZmM5MGRmMmY5MGMzZjIzZmJiNDhfalUyTDZpMjhGMXlwUkpyQ1R2a2lDMW9WUDJWUVQzSGVfVG9rZW46Ym94Y245eFNEN1BZeFh1SjhCSTVncXlaM0ZOXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

å½“ç„¶ï¼Œè¿™ä¸ª CPE åœ¨å®é™…å·¥ä½œä¸­è®¡ç®—å‡ºæ¥æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œä½†æ˜¯å¯¹äºäº†è§£å¸¸è§æ±‡ç¼–æŒ‡ä»¤çš„é€Ÿåº¦è¿˜æ˜¯æœ‰ä¸€å®šå¸®åŠ©ã€‚

1. # ç¼–è¯‘å™¨ä¼˜åŒ–çš„èƒ½åŠ›å’Œå±€é™æ€§

## ç¼–è¯‘å™¨èƒ½åšå•¥ï¼Ÿ

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=M2JhY2QzZGJhZGUwYjAzNDZiYzZjMzE1MGFkZTJmMzdfQWxKbXNlRXNoQkNBejEwU3R6RlZzeE5BMHlqWmJsd0VfVG9rZW46Ym94Y25tNzBIV3h0a3lmWFR1TGppMXplY3RkXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YTFkOWNmMzRmZmViZGNmOTE2MGJkNTc3ZjMyZTJmZDFfSGFCS3p2dUd5Q0pTVVRiRGJNUnZ2M0JTQ0U5d01nckRfVG9rZW46Ym94Y254TmJRUDBpU3BIcWppU0RQVmhXVG5iXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2QxMGY2Njg2N2FjZWI1ZTNhZjkzMzBmNWU2NzQ3OGNfNW9VR2UwV0VNc3JTWlFXMFpva2ZORXNMSHA3T1hsU2pfVG9rZW46Ym94Y25CTXMzcGxZTjdYSDBKZklXQmU0TnhoXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

- ç§»é™¤é‡å¤æ“ä½œ
- ä¼˜åŒ–è®¡ç®—è¡¨è¾¾å¼
- ä½¿ç”¨å…¬å…±å˜é‡

## ç¼–è¯‘å™¨æŒ«åœ¨å“ªï¼Ÿ

### æŒ«ä¸€ï¼šå¤„ç†å‡½æ•°è°ƒç”¨

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjM3NjIwZmMzZTgyNGE2OWJmZjY3Yjk0NmY1MzFkZjlfVFNTU1hod2xmcVpqZ3N5WFBhSjZSVjBmaDNzS01TQmxfVG9rZW46Ym94Y25xYnVsMW8ybUJZYTVNOXVyNDJzMmdnXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

**ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸èƒ½å¤Ÿå‘ç°ï¼Œå¹¶å°†** `**strlen**` **æå–åˆ°å¾ªç¯å¤–ï¼Ÿ**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MDZhNzc1MjdkODNkM2RmMzc4ZGUzZjJmNjIxZDU4NTlfU3h2djVWWlpmVEZYWjBZdzlmZHVlNnlvYnRaNHF2SUhfVG9rZW46Ym94Y25IZThoSm5NYnNtOU1PTEFXamdFMjBmXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

- å‡½æ•°å¯èƒ½æœ‰å‰¯ä½œç”¨ï¼Œä¾‹å¦‚ä¿®æ”¹æŸä¸ªå…¨å±€å˜é‡
- å‡½æ•°ä¸ä¸€å®šæ˜¯å¹‚ç­‰çš„ï¼Œä¾‹å¦‚ä¾èµ–æŸä¸ªå…¨å±€å˜é‡

ç¼–è¯‘å™¨å€¾å‘äºæŠŠå‡½æ•°è°ƒç”¨å½“ä½œé»‘ç›’ï¼Œå› ä¸ºæ— æ³•çŸ¥é“å…¶å‰¯ä½œç”¨ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹æ­¤è¿›è¡Œä¼˜åŒ–ã€‚

â€‹                                           â€”â€” é²è¿…

### æŒ«äºŒï¼šå†…å­˜åˆ«åå¼•ç”¨

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MjJkYTA5OTU5MWQ3ODJiNDNhNDc4N2JiMjFkMmExNTFfM3V6ZnhoNHNSTnNMQ1lsQ2c1OHJWVHc1YUtvYVU2OGRfVG9rZW46Ym94Y25UMk5MWkl1Q1U0T1p6Rnd5VVJtTHVlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MzI5MTdhZDNlMmI5ZTExMDk3ZjhiNDhiYTUzOGM2ZjVfRXE5bGU5dXg3eHR1cmphMTZsdnNXSkYyOTdtWE1CSGdfVG9rZW46Ym94Y25oc2FlUlJ5VmVUUll2UnZkTllYZkJnXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

**ç¼–è¯‘å™¨ä¸èƒ½ä¼˜åŒ–è¿™ç‚¹å—ï¼Ÿ**

çœ‹ä¸Šå»ç¼–è¯‘å™¨ä¼¼ä¹èƒ½å¤Ÿä¼˜åŒ–è¿™ç‚¹ï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¼šå‡è®¾ä¸¤ä¸ªæŒ‡é’ˆåœ°å€å¯èƒ½ç›¸åŒï¼Œå› æ­¤å¿…é¡»éå¸¸è°¨æ…ï¼Œèººå¹³ä¸åŠ¨ã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTM5YmU5NzIxODI4MDBjYzYyMTNlYzg3NmI0MmZmOTZfaElmYWR2Wm5RSmRoMUVwWXVUaG1WMWRRYU5INVJxdkdfVG9rZW46Ym94Y25hSWpnTTBwVHdoOFRaTlRWMGNwdjJnXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

ç¨‹åºå‘˜è¦å…»æˆä½¿ç”¨å±€éƒ¨å˜é‡çš„ä¹ æƒ¯ï¼Œæ˜¾å¼åœ°å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™é‡Œæ²¡æœ‰å†…å­˜åˆ«åã€‚

â€‹                                           â€”â€” é²è¿…

1. # ç°ä»£å¾®å¤„ç†å™¨

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æåŠåˆ°çš„ä¼˜åŒ–æŠ€å·§ï¼Œéƒ½ä¸ä¾èµ–äºç›®æ ‡æœºå™¨çš„ä»»ä½•ç‰¹æ€§ã€‚æˆ‘ä»¬ç›®å‰çš„ä¼˜åŒ–ï¼Œåªæ˜¯ç®€å•çš„é™ä½äº†è¿‡ç¨‹è°ƒç”¨çš„å¼€é”€ã€é¿å¼€äº†ç¼–è¯‘å™¨çš„æŒ«ã€‚å¦‚æœè¦è¿›ä¸€æ­¥è¿›è¡Œä¼˜åŒ–ï¼Œå¿…é¡»è€ƒè™‘åˆ©ç”¨ç°ä»£å¾®å¤„ç†å™¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å™¨ç”¨æ¥æ‰§è¡ŒæŒ‡ä»¤çš„åº•å±‚ç³»ç»Ÿè®¾è®¡ã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MTFlY2Q3MDVkNTFjOWExZjA5NWZhZDA2YzljODlkYzNfRG9HZmpwcjBpSTdXQ1ZhOUxabzBrUDhqYWxsVVowWGJfVG9rZW46Ym94Y25zMkhGWmVHVXF0TndKUlNFejVUR1lnXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

è¿™æ ·çš„å¤„ç†å™¨ï¼Œåœ¨å·¥ä¸šç•Œç§°ä¸ºè¶…æ ‡é‡ï¼ˆSuperscalarï¼‰ï¼Œ**å³æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå¯ä»¥æ‰§è¡Œå¤šä¸ªæŒ‡ä»¤ï¼Œä¸”æ˜¯ä¹±åºæ‰§è¡Œ**ã€‚æ•´ä¸ªå¤„ç†å™¨åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼ŒæŒ‡ä»¤æ§åˆ¶å•å…ƒï¼ˆICUï¼‰å’Œæ‰§è¡Œå•å…ƒï¼ˆEUï¼‰ã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MDQxY2M3MTU5MzZmM2IxZDkyN2EyZTRkMWM5ZDMzNDVfOEIzNWZWRk5wZkoxNWpYaTI1MVhkSjVrMFFKdnZxZXFfVG9rZW46Ym94Y251YlpLU041bjJHWERVSzFMc3dFbVc5XzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

- **æŒ‡ä»¤æ§åˆ¶å•å…ƒ**ï¼šä»é«˜é€Ÿç¼“å­˜ä¸­å–æŒ‡ã€è¯‘ç ï¼Œç”Ÿæˆä¸€ç»„ low level çš„åŸºæœ¬æ“ä½œï¼›
- **æ‰§è¡Œå•å…ƒ**ï¼šæ‰§è¡Œä¸Šè¿°åŸºæœ¬æ“ä½œï¼›åŒ…æ‹¬å¤šä¸ªåŠŸèƒ½å•å…ƒï¼Œæ¯”å¦‚ arithï¼ˆç®—æœ¯è¿ç®—ï¼‰ã€loadï¼ˆå†…å­˜è¯»ï¼‰ã€storeï¼ˆå†…å­˜å†™ï¼‰ç­‰ç­‰ï¼Œåˆ†åˆ«è´Ÿè´£å„è‡ªç‹¬ç«‹çš„è®¡ç®—å’Œå­˜å–å†…å­˜æ“ä½œã€‚

å½“ç¨‹åºé‡åˆ°åˆ†æ”¯çš„æ—¶å€™ï¼Œç¨‹åºå¯èƒ½æœ‰ä¸¤ä¸ªå‰è¿›çš„æ–¹å‘ã€‚ç°ä»£å¤„ç†å™¨ä½¿ç”¨äº†**åˆ†æ”¯é¢„æµ‹**æŠ€æœ¯ï¼ˆBranch Predictionï¼‰ï¼Œä¼šçŒœæµ‹æ˜¯å¦é€‰æ‹©åˆ†æ”¯ï¼Œä¸”ä¼šé¢„æµ‹åˆ†æ”¯è·³è½¬çš„ç›®æ ‡åœ°å€ã€‚ç„¶åä½¿ç”¨**æŠ•æœºæ‰§è¡Œ**ï¼ˆSpeculative Executionï¼‰æŠ€æœ¯å¯¹ç›®æ ‡åˆ†æ”¯è·³è½¬åˆ°çš„æŒ‡ä»¤è¿›è¡Œå–æŒ‡å’Œè¯‘ç ï¼ˆç”šè‡³åœ¨åˆ†æ”¯é¢„æµ‹ä¹‹å‰å°±å¼€å§‹æŠ•æœºæ‰§è¡Œï¼‰ã€‚å¦‚æœä¹‹åç¡®å®šåˆ†æ”¯é¢„æµ‹é”™è¯¯ï¼Œåˆ™ä¼šå°†å¯„å­˜å™¨çŠ¶æ€é‡ç½®ä¸ºåˆ†æ”¯ç‚¹çš„çŠ¶æ€ï¼Œå¹¶å¼€å§‹å–å‡ºå’Œæ‰§è¡Œå¦ä¸€ä¸ªåˆ†æ”¯ä¸Šçš„æŒ‡ä»¤ã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼Œ**åˆ†æ”¯é¢„æµ‹é”™è¯¯ä¼šå¯¼è‡´å¾ˆå¤§çš„æ€§èƒ½å¼€é”€ã€‚**

1. # è®©å¤„ç†å™¨åŠ©ä½ ä¸€è‡‚ä¹‹åŠ›å§ï¼

## å¾ªç¯å±•å¼€

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=N2U1MjQ4Y2IzOTFmMjIzMGIyNzQwMjkzMDViZGUxMjBfdDhRTGlNRnYwaFQzOUhUVW9QWXd0aE1yaVVuVFhsWGFfVG9rZW46Ym94Y25tdnoyUnF5M0lpczBKOVZ2aGpZUjJiXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NDZiMDBkMDJhNGU3MDE1ZmNhY2FjYmQyYjcyY2VhMWFfckt5eHl2RW9Kd3RPdWxBdndlcUFYdE5wQkF0YTdFYUFfVG9rZW46Ym94Y25Va0xBTEowYUFaYWZmenlYVm9xMFBlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

ä¼˜åŒ–å‰åçš„å…³é”®è·¯å¾„å¯¹æ¯”ï¼Œ**å¯ä»¥çœ‹åˆ°æ¯ 2 ä¸ª Elementï¼ŒèŠ‚çœäº†ä¸€ä¸ª load æ“ä½œï¼Œé€Ÿåº¦æé«˜ 20%ï¼š**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTE1OWQ4NmUzNzgxNzhmNzM4NjI3NDFmYjgwMjViOTVfSnptcjBXaTMycDdmR3FiWE84WXA2UU5DWkNiVVk0UHlfVG9rZW46Ym94Y25wajg5UThGU01uNXNyMDhGQmNhcE50XzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NTE5NTdmMmMwNThhZmM5MGRmMmY5MGMzZjIzZmJiNDhfalUyTDZpMjhGMXlwUkpyQ1R2a2lDMW9WUDJWUVQzSGVfVG9rZW46Ym94Y245eFNEN1BZeFh1SjhCSTVncXlaM0ZOXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

## æé«˜å¹¶è¡Œæ€§

### åˆ†æ²»æ³•

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NDZiMDBkMDJhNGU3MDE1ZmNhY2FjYmQyYjcyY2VhMWFfckt5eHl2RW9Kd3RPdWxBdndlcUFYdE5wQkF0YTdFYUFfVG9rZW46Ym94Y25Va0xBTEowYUFaYWZmenlYVm9xMFBlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjQzMjY4ZjYyNDcwZTQxMDFjNjBkMjBiZDA4ODg3YThfTWZyaUZmOWdQZ1VoZkliTm9CbUZxRHZHWWtBNnFPeEZfVG9rZW46Ym94Y25wbmx5SnRJaDJ2S2c3M2M1cjJpOFRkXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

ä¼˜åŒ–å‰åçš„å…³é”®è·¯å¾„å¯¹æ¯”ï¼Œ**å¯ä»¥çœ‹åˆ°æ¯ä¸ª 2 ä¸ª Elementï¼ŒèŠ‚çœäº† mul æ“ä½œï¼Œé€Ÿåº¦æé«˜ 1x å¤šï¼š**

- å·¦è¾¹å…³é”®è·¯å¾„ï¼šload+2*mul=8
- å³è¾¹å…³é”®è·¯å¾„ï¼šload+mul=5

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NTE5NTdmMmMwNThhZmM5MGRmMmY5MGMzZjIzZmJiNDhfalUyTDZpMjhGMXlwUkpyQ1R2a2lDMW9WUDJWUVQzSGVfVG9rZW46Ym94Y245eFNEN1BZeFh1SjhCSTVncXlaM0ZOXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MGY4YWQ5ZDRkMmE3MTU3YTdlYTNjMGM2YzgwNjlhYmRfWDZLYlNBQnVWMnkxWFJVUDBHbnhmTFoxb1BQV1Fib0ZfVG9rZW46Ym94Y25waGRZMU5WYXprY09IZW9JeWZrTTN6XzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

### é‡æ–°ç»“åˆè¿ç®—

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NDZiMDBkMDJhNGU3MDE1ZmNhY2FjYmQyYjcyY2VhMWFfckt5eHl2RW9Kd3RPdWxBdndlcUFYdE5wQkF0YTdFYUFfVG9rZW46Ym94Y25Va0xBTEowYUFaYWZmenlYVm9xMFBlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MjliZjU3NzkzOTI1NzhmNzU0ZjVkODM0MjAxMmM3NmJfSnZkZHliVkRPZGZ5RWxCTUFGd3F2ZzhBOTNMQk03QWZfVG9rZW46Ym94Y25iaFlORDcxaExnNE9TaWdEajZKbEhjXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

ä¼˜åŒ–å‰åçš„å…³é”®è·¯å¾„å¯¹æ¯”ï¼Œ**å¯ä»¥çœ‹åˆ°æ¯ä¸ª 4 ä¸ª Elementï¼ŒèŠ‚çœäº† 2mul+2load æ“ä½œï¼Œé€Ÿåº¦æé«˜ 2x å¤šï¼š**

- å·¦è¾¹å…³é”®è·¯å¾„ï¼š(load+2*mul)*2=16
- å³è¾¹å…³é”®è·¯å¾„ï¼š2*mul=6

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NTE5NTdmMmMwNThhZmM5MGRmMmY5MGMzZjIzZmJiNDhfalUyTDZpMjhGMXlwUkpyQ1R2a2lDMW9WUDJWUVQzSGVfVG9rZW46Ym94Y245eFNEN1BZeFh1SjhCSTVncXlaM0ZOXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=M2E3ZGIwYjI5YmNjODUxMDJkNDgzZjFlZmVlYjZjYzBfM1RXWXNibGJ5andMYzVjTWFPV0dYZ0FsZ3VlR0VBcWJfVG9rZW46Ym94Y25MYnpJWDcxYU9ZMDJSdUFrM1I4ZjdlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

### å°ç»“

æœ¬è´¨ï¼šè§£é™¤æ•°æ®ä¾èµ–

1. åˆ†æ²»æ³•ï¼šåˆ©ç”¨æ¯ä¸ªå­é—®é¢˜çš„å¹¶è¡Œæ‰§è¡Œæé«˜é€Ÿåº¦
2. é‡æ–°ç»“åˆå˜æ¢ï¼šè§£é™¤å¤šé¡¹å¼æ“ä½œä¸­ï¼Œé¡¹ä¹‹é—´çš„å…³é”®ä¾èµ–

## åˆ†æ”¯

1. ä¹¦å†™å®¹æ˜“é¢„æµ‹çš„ä»£ç 

[ğŸ‘‰ Why is processing a sorted array faster than processing an unsorted array? - Stack Overflow](https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array)

ç°ä»£å¤„ç†å™¨å¯ä»¥å¾ˆå¥½é¢„æµ‹åˆ†æ”¯æŒ‡ä»¤çš„**æœ‰è§„å¾‹æ¨¡å¼**ã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YTgyNDMxMDc4MTc4NGJiMmJkZDQ0ZGE1ZWY4ZDZkZjdfc2dvYUF2UktLT1dCRGgwRUxoYVVVU1Fnc2RMcEZjUjhfVG9rZW46Ym94Y256azBiOW9jemdTdkl1U3NibFJPWVRoXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NzQwNmRhOTkxZjVkZDlhYjZiMGVjMjhiYzNjMmJhYjJfN0RIWkpXZ3pKZDgzazR1TXpjdjBISGtHelh1am5LWkRfVG9rZW46Ym94Y25Ya3hYN2s5R3RWeTBWeHhkcHl6WGlkXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NTQ1ODMwZjgyNTU4MTM5M2M4ZTMxMjg3NTI4YWE5OTNfYXRDUGgwT3ByWEI5UzZJWENibVM3eTRxbjY0djVvdlRfVG9rZW46Ym94Y242NG9hZVp4ZXJ2YmREYXhxRVp3WU9jXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

**ğŸ‘‰** **[CPU çš„åˆ†æ”¯é æ¸¬å™¨æ˜¯æ€æ¨£å·¥ä½œçš„ï¼Ÿ](https://www.zhihu.com/question/23973128)**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=OTU4ZTI5YzgxOGE5NmUzMzA0NGIzMGU0NzVjM2ZkM2ZfTHNlUzZJZnhiTTU4YzFGSlR6ODZVTlNidG5zS2Z5RldfVG9rZW46Ym94Y241a0VTeWRDYTZkdXBGY1YwZXJlWkpjXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

1. ä¹¦å†™é€‚åˆ**æ¡ä»¶ä¼ é€**çš„ä»£ç 

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDI2ZTU1MzYwNTIyNDYyYjIzY2FjM2IwNjU4MTcwZTNfRTJ0R2tmOVVsM08xTlVUaGd0YmxzazZjZDhTRmpiUGpfVG9rZW46Ym94Y25URmRrQ1dnQnRKOW5sR3VydTgyMXljXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTMxZWUxMjJlZjk0ZTEyZmIyZjgzNGUyMjlkM2UxNGNfSDBmN2tINmpaaDBwRGZXQUxCYkg5UU5kY1hRVHV0NmtfVG9rZW46Ym94Y25zelVYTHVvOEdRR2JMT3JBN01VZnliXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

- **æ¡ä»¶è·³è½¬**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=OWZjYWZiYzk5NTA2MTI2YWNiNjBkZDllODBlNTQyMDRfMTRLTTcwNWozZktnTE1lTXA1ajlzQ0ppOTJyMjVBWVVfVG9rZW46Ym94Y24xdnIxVENac0ExRW1zU1NLM0E4WlVlXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

- **æ¡ä»¶ä¼ é€**

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=OTNiOTQ1YzQ1MWMyYTI4MjkzZjIyZjNlZjQ1OTUzZmNfT3FORFl4c1k5SnY2MndrSHRoVzFSQThRS0ZJWE1tcjdfVG9rZW46Ym94Y24xQ04zT1hYS2l5UGh1Qnp3bU9rRU1lXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

**ä¸ºä»€ä¹ˆæ¡ä»¶ä¼ é€æ›´å¿«ï¼Ÿ**

å…ˆè®¡ç®—ï¼Œå†é€‰æ‹©ç»“æœã€‚ä¸”è¿™äº›è®¡ç®—æ²¡æœ‰æ•°æ®ä¾èµ–ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤„ç†å™¨çš„æŒ‡ä»¤æµæ°´ã€‚

## SIMD

> SIMDï¼ˆ**Single Instruction Multiple Data****ï¼‰**å³å•æŒ‡ä»¤æµå¤šæ•°æ®æµï¼Œæ˜¯ä¸€ç§é‡‡ç”¨ä¸€ä¸ªæ§åˆ¶å™¨æ¥æ§åˆ¶å¤šä¸ªæ‰§è¡Œå™¨ï¼ŒåŒæ—¶å¯¹ä¸€ç»„æ•°æ®ï¼ˆåˆç§°â€œæ•°æ®å‘é‡â€ï¼‰ä¸­çš„æ¯ä¸€ä¸ªåˆ†åˆ«æ‰§è¡Œç›¸åŒçš„æ“ä½œä»è€Œå®ç°ç©ºé—´ä¸Šçš„å¹¶è¡Œæ€§çš„æŠ€æœ¯ã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®ã€‚

[Achieving Greater Parallelism with SIMD Instructions](http://csapp.cs.cmu.edu/3e/waside/waside-simd.pdf)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGQ5YWUzZTkwOWEyY2YzYjBiYWQ3MzY4ZDc1ZTg0OGZfVDBpSGRNdkdEeTdFRFpaQUszWVA3SzJNM09hTmd5ZTVfVG9rZW46Ym94Y245MjlDSkk0NTI3SXlLYXFkUkg2MzBjXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

1. # å°ç»“

- è‰¯å¥½çš„ç¼–ç ä¹ æƒ¯
  - æ•°æ®ç»“æ„ä¸ç®—æ³•
  - æ¶ˆé™¤ç¼–è¯‘å™¨ä¼˜åŒ–éšœç¢
    - è¿‡ç¨‹è°ƒç”¨
    - å†…å­˜åˆ«åå¼•ç”¨
  - ä¼˜åŒ–å¾ªç¯
- å¸®åŠ©æœºå™¨æ›´å¥½åœ°ä¼˜åŒ–
  - åˆ©ç”¨æŒ‡ä»¤å¹¶è¡Œ
  - é¿å…ä¸å¯é¢„æµ‹çš„åˆ†æ”¯
  - æé«˜æŒ‡ä»¤ç¼“å­˜å‘½ä¸­ç‡

**æœ¬æ–‡æ‰€è®²çš„è¿™äº›ä¼˜åŒ–æ–¹æ³•ï¼Œåœ¨å¤§éƒ¨åˆ†ç¼–è¯‘å™¨ä¸­éƒ½å·²ç»å®ç°äº†ã€‚**ä½†æ˜¯å®ƒä»¬æœ‰å¯èƒ½ä¸ä¼šå®è¡Œè¿™äº›ä¼˜åŒ–ï¼Œæˆ–éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è®¾ç½®æ›´é«˜çº§åˆ«çš„ä¼˜åŒ–é€‰é¡¹æ‰è¡Œã€‚æ‰€ä»¥ï¼Œ**ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæˆ‘ä»¬åº”è¯¥åšçš„æ˜¯å°½é‡å¼•å¯¼ç¼–è¯‘å™¨æ‰§è¡Œè¿™äº›ä¼˜åŒ–ï¼Œæˆ–è€…è¯´æ’é™¤é˜»ç¢ç¼–è¯‘å™¨ä¼˜åŒ–çš„éšœç¢ã€‚**è¿™æ ·å¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç åœ¨ä¿æŒç®€æ´çš„æƒ…å†µä¸‹è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚è¿«ä¸å¾—å·²æ—¶ï¼Œæˆ‘ä»¬æ‰å»æ‰‹åŠ¨åšè¿™äº›ä¼˜åŒ–ã€‚

å¦å¤–ï¼Œå¾ªç¯å±•å¼€ã€å¤šè·¯å¹¶è¡Œå¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚å› ä¸ºå¯„å­˜å™¨çš„ä¸ªæ•°æ˜¯æœ‰é™çš„ï¼Œx86-64 æœ€å¤šåªèƒ½æœ‰ 12 ä¸ªå¯„å­˜å™¨ç”¨äºç´¯åŠ ï¼Œå¦‚æœå±€éƒ¨å˜é‡çš„ä¸ªæ•°å¤šäº 12 ä¸ªï¼Œå°±ä¼šè¢«æ”¾è¿›å­˜å‚¨å™¨ï¼Œåå€’ä¸¥é‡æ‹‰ä½ç¨‹åºæ€§èƒ½ã€‚

1. # èº«è¾¹æ´»ç”Ÿç”Ÿçš„ä¾‹å­

## æ•°æ®ä¾èµ–

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDhhODk3NDcyNWUxNTU1NWM3ZDVjOWJlNzc2ZWUzMGRfQUhaMHAwdUZTb0dIWWwyaTBROXNFQ1hiUHJzNjJ3dUZfVG9rZW46Ym94Y25HT1RxVXdRdXdMODJrcjVuQ2o2M1BkXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

## æŒ‡ä»¤ç¼“å­˜

> åŸæ–‡é“¾æ¥ ğŸ‘‰ [ä½¿ç”¨äººå·¥æ™ºèƒ½ä¼˜åŒ– Golang ç¼–è¯‘å™¨ - æ–‡ç«  - ByteTech (bytedance.net)](https://tech.bytedance.net/articles/6883384310477357063)

äº‹æ•…ç°åœºï¼š[Mergely - Diff online, merge documents](https://editor.mergely.com/HPqQpVCJ/)

æœ€ç»ˆï¼Œæˆ‘ä»¬å®šä½åˆ°äº†æ˜¯ç”±äºåœ¨æ–°çš„ç”Ÿæˆä»£ç ä¸­ï¼Œç›¸æ¯”æ—§ç‰ˆæœ¬çš„ç”Ÿæˆä»£ç ï¼Œåœ¨è¿”å›é”™è¯¯çš„æ—¶å€™ä¼šé¢å¤–åŒ…è£…ä¸€ä¸‹ï¼š

```Go
if err := ...; err != nil {

    return thrift.PrependError(fmt.Sprintf("%T read field x 'xxx' error: ", p), err)

}
```

è€Œæ—§ç‰ˆæœ¬çš„ç”Ÿæˆä»£ç æ˜¯ç›´æ¥è¿”å›çš„é”™è¯¯ï¼š

```Go
if err := ...; err != nil {

    return err

}
```

è™½ç„¶è¿™äº›åªæ˜¯åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æ‰ä¼šè°ƒç”¨åˆ°ï¼Œåœ¨æ­£å¸¸æµç¨‹ä¸­ä¸ä¼šç”¨åˆ°ï¼Œä½†æ˜¯ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­è¿™æ®µé€»è¾‘å äº†ç›¸å½“å¤§çš„æ¯”ä¾‹ï¼š

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YjIzNGQ2MGE1OTY1MDJlYThjYmI5YjExNWI4ZDU2MTFfakFROVpGRko3eXFpMXZTbFhyb1U1VEd6QkRTaFNqQ1FfVG9rZW46Ym94Y25ZbU1SQkYzZ0QzaGNwMkxjUUJiUEpLXzE2NjExNzIwNTc6MTY2MTE3NTY1N19WNA)

è€Œ Go çš„ç¼–è¯‘å™¨å¹¶æ²¡æœ‰å¸®æˆ‘ä»¬é‡æ’è¿™äº›æŒ‡ä»¤ï¼Œå¯¼è‡´åœ¨çœŸæ­£è¿è¡Œçš„æ—¶å€™ï¼ŒL1 cache miss å¤§å¤§æé«˜ï¼Œæå¤§åœ°é™ä½äº†æ€§èƒ½ã€‚

# æ‹“å±•é˜…è¯»

- Golang æ€§èƒ½æµ‹é‡ã€ä¼˜åŒ– [Golang pprof æ€§èƒ½ä¼˜åŒ–](https://bytedance.feishu.cn/wiki/wikcnuGOBeXF40JQEtgJUJ6ttFa#NXrBCa)ã€[Golang æ€§èƒ½æµ‹é‡å’Œåˆ†æ](https://github.com/sxs2473/go-performane-tuning/blob/master/3.æ€§èƒ½æµ‹é‡å’Œåˆ†æ/æ€§èƒ½æµ‹é‡å’Œåˆ†æ.md)
- å…¶ä»–ä¼˜åŒ–æŠ€å·§ [Go GC æ€§èƒ½ä¼˜åŒ–æŠ€å·§ - è§†é¢‘ - ByteTech (bytedance.net)](https://tech.bytedance.net/videos/6844026138000359432)

# Reference

- CMU è¯¾ä»¶ [10-optimization](http://www.cs.cmu.edu/afs/cs/academic/class/15213-f15/www/lectures/10-optimization.pdf)
- CMU ç”µå­ä¹¦ã€è¯¾ç¨‹ç­‰èµ„æ–™åœ°å€ [wangmu89/Book-CSAPP: æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ](https://github.com/wangmu89/Book-CSAPP)
